FROM centos
# FROM centos:centos6

# author infomation
MAINTAINER wikift

# create wikift application dir
RUN mkdir /wikift

# set volume to /wikift
VOLUME /wikift

# add wikift config to container
ADD wikift.example.conf /etc/wikift/wikift.conf

# rename wikift server file
ADD wikift-server-1.0.0.jar /wikift/wikift-server.jar

# add wikift database schema
ADD schema.sql data.sql update.sql wikift-init.sh /wikift/

# get mysql repo
RUN rpm -ivh http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm

# install required dependency
# RUN yum -y install java-1.8.0-openjdk* mysql-server
RUN yum -y install mysql-server

# init mysql db admin user
RUN mysql_install_db --user=root

# changer mysql dir owber
RUN chown -R mysql:mysql /var/lib/mysql*
RUN chown -R mysql:mysql /var/run/mysqld

# start mysql server
# RUN /usr/bin/mysql-systemd-start
# RUN /usr/bin/mysqld_safe
CMD ["/usr/bin/mysqld_safe"]
RUN cat /var/log/mysqld.log

# set mysql default password
RUN /usr/bin/mysqladmin -u root password '123456'

# init wikift database
CMD ["sh", "/wikift/wikift-init.sh"]

RUN sh -c 'touch /wikift-server.jar'

ENV JAVA_OPTS=""

ENTRYPOINT [ "sh", "-c", "java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -jar /wikift-server.jar" ]